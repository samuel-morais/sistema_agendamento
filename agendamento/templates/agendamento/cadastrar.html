{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Cadastro{% endblock %}

{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  body {
    background: linear-gradient(135deg, #4e54c8, #8f94fb);
    font-family: 'Inter', sans-serif;
    color: #333;
    min-height: 100vh;
  }

  .register-page {
    display: flex;
    align-items: center;
    justify-content: center;
    height: calc(100vh - 60px);
    padding: 1rem;
  }

  .register-card {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(12px);
    border-radius: 1rem;
    padding: 3rem 2rem;
    max-width: 440px;
    width: 100%;
    text-align: center;
    box-shadow: 0 12px 40px rgba(78, 84, 200, 0.3);
    transition: all 0.4s ease;
  }

  .register-card:hover {
    transform: translateY(-6px);
    box-shadow: 0 18px 50px rgba(78, 84, 200, 0.4);
  }

  .register-logo img {
    max-width: 110px;
    margin-bottom: 1rem;
    filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
    animation: bounceLogo 1.5s ease;
  }

  @keyframes bounceLogo {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
  }

  .input-group.invalid {
    border-color: #e63946 !important;
    box-shadow: 0 0 0 3px rgba(230, 57, 70, 0.3) !important;
  }

  .input-group.valid {
    border-color: #2ecc71 !important;
    box-shadow: 0 0 0 3px rgba(46, 204, 113, 0.3) !important;
  }

  .error-msg {
    font-size: .85rem;
    color: #e63946;
    text-align: left;
    margin-top: 4px;
  }

  .success-msg {
    font-size: .85rem;
    color: #2ecc71;
    text-align: left;
    margin-top: 4px;
  }
</style>

<div class="register-page">
  <div class="register-card animate-rise">

    <div class="register-logo">
      <img src="{% static 'images/logo.png' %}" alt="Logo do Sistema">
    </div>

    <h3>üìù Criar Nova Conta</h3>

    <form method="post" id="registerForm" novalidate>
      {% csrf_token %}

      <!-- Usu√°rio -->
      <div class="mb-3 text-start">
        <label for="id_username" class="form-label">Usu√°rio</label>
        <div class="input-group" id="group-username">
          <span class="input-group-text"><i class="bi bi-person"></i></span>
          {{ form.username|add_class:"form-control" }}
        </div>
        <div id="username-msg"></div>
      </div>

      <!-- Email -->
      <div class="mb-3 text-start">
        <label for="id_email" class="form-label">E-mail</label>
        <div class="input-group" id="group-email">
          <span class="input-group-text"><i class="bi bi-envelope"></i></span>
          {{ form.email|add_class:"form-control" }}
        </div>
        <div id="email-msg"></div>
      </div>

      <!-- Senha -->
      <div class="mb-3 text-start">
        <label for="id_password1" class="form-label">Senha</label>
        <div class="input-group" id="group-pass1">
          <span class="input-group-text"><i class="bi bi-key"></i></span>
          {{ form.password1|add_class:"form-control" }}
        </div>
        <div id="pass1-msg" class="small text-muted">M√≠nimo 8 caracteres, 1 n√∫mero e 1 letra mai√∫scula.</div>
      </div>

      <!-- Confirmar Senha -->
      <div class="mb-4 text-start">
        <label for="id_password2" class="form-label">Confirmar Senha</label>
        <div class="input-group" id="group-pass2">
          <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
          {{ form.password2|add_class:"form-control" }}
        </div>
        <div id="pass2-msg"></div>
      </div>

      <button type="submit" class="btn btn-primary w-100 mb-3">
        <i class="bi bi-person-plus"></i> Criar Conta
      </button>

      <a href="{% url 'login' %}" class="btn btn-outline-primary w-100">
        <i class="bi bi-box-arrow-in-right"></i> J√° tenho uma conta
      </a>
    </form>

    <p class="text-muted small mt-4 mb-0">
      ¬© {{ now|date:"Y" }} Sistema de Agendamento ‚Äî Todos os direitos reservados
    </p>
  </div>
</div>

<script>
/* Fun√ß√µes utilit√°rias */
function setValid(group, msgBox, text="") {
  group.classList.remove("invalid");
  group.classList.add("valid");
  msgBox.innerHTML = text ? `<div class="success-msg">${text}</div>` : "";
}

function setInvalid(group, msgBox, text) {
  group.classList.remove("valid");
  group.classList.add("invalid");
  msgBox.innerHTML = `<div class="error-msg">${text}</div>`;
}

/* Valida√ß√£o AJAX: Username */
document.getElementById("id_username").addEventListener("blur", function() {
  const username = this.value.trim();
  const group = document.getElementById("group-username");
  const msg = document.getElementById("username-msg");

  if (username.length < 3) {
    setInvalid(group, msg, "M√≠nimo de 3 caracteres.");
    return;
  }

  fetch("/validar/username/?u=" + username)
    .then(r => r.json())
    .then(data => {
      if (data.exists) setInvalid(group, msg, "Este usu√°rio j√° est√° em uso.");
      else setValid(group, msg, "Usu√°rio dispon√≠vel!");
    });
});

/* Valida√ß√£o AJAX: Email */
document.getElementById("id_email").addEventListener("blur", function() {
  const email = this.value.trim();
  const group = document.getElementById("group-email");
  const msg = document.getElementById("email-msg");

  if (!email.includes("@") || email.length < 8) {
    setInvalid(group, msg, "E-mail inv√°lido.");
    return;
  }

  fetch("/validar/email/?e=" + email)
    .then(r => r.json())
    .then(data => {
      if (data.exists) setInvalid(group, msg, "E-mail j√° cadastrado.");
      else setValid(group, msg, "E-mail dispon√≠vel!");
    });
});

/* Valida√ß√£o senha forte*/
document.getElementById("id_password1").addEventListener("input", function() {
  const val = this.value;
  const group = document.getElementById("group-pass1");
  const msg = document.getElementById("pass1-msg");

  const strong = /^(?=.*[A-Z])(?=.*[0-9]).{8,}$/;

  if (!strong.test(val)) {
    setInvalid(group, msg, "Senha fraca ‚Äî use 8+ caracteres, n√∫mero e letra mai√∫scula.");
  } else {
    setValid(group, msg, "Senha forte!");
  }
});

/* Confirmar senha */
document.getElementById("id_password2").addEventListener("input", function() {
  const pass1 = document.getElementById("id_password1").value;
  const pass2 = this.value;

  const group = document.getElementById("group-pass2");
  const msg = document.getElementById("pass2-msg");

  if (pass2 !== pass1) {
    setInvalid(group, msg, "As senhas n√£o coincidem.");
  } else {
    setValid(group, msg, "Senhas combinam!");
  }
});

/* Confirma√ß√£o antes de enviar */
document.getElementById("registerForm").addEventListener("submit", function(e) {
  if (!confirm("Deseja criar essa conta?")) {
    e.preventDefault();
  }
});
</script>

{% endblock %}
