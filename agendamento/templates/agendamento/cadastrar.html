{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Criar Conta{% endblock %}

{% block content %}

<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

  body {
    background: linear-gradient(135deg, #5a60ea, #8f94fb);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
  }

  .register-wrapper {
    display: flex;
    justify-content: center;
    padding: 40px 20px;
  }

  .register-card {
    width: 100%;
    max-width: 460px;
    background: rgba(255, 255, 255, 0.95);
    padding: 2.8rem 2rem;
    border-radius: 1.2rem;
    box-shadow: 0 12px 35px rgba(0,0,0,0.15);
    animation: fadeIn .5s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .form-title {
    font-weight: 700;
    font-size: 1.7rem;
    text-align: center;
    margin-bottom: 1.5rem;
    color: #333;
  }

  .input-group.invalid {
    box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.3);
    border-radius: .5rem !important;
  }

  .input-group.valid {
    box-shadow: 0 0 0 3px rgba(25, 135, 84, 0.3);
    border-radius: .5rem !important;
  }

  .error-msg {
    font-size: 0.85rem;
    color: #dc3545;
    margin-top: 4px;
  }

  .success-msg {
    font-size: 0.85rem;
    color: #198754;
    margin-top: 4px;
  }

  .btn-primary, .btn-outline-primary {
    padding: .8rem;
    font-size: 1.05rem;
    border-radius: .6rem;
  }
</style>

<div class="register-wrapper">
  <div class="register-card">

    <div class="text-center mb-3">
      <img src="{% static 'images/logo.png' %}" width="120">
    </div>

    <h2 class="form-title">Criar Nova Conta</h2>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} text-center">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" id="cadastrarForm" novalidate>
      {% csrf_token %}

      <!-- Usuário -->
      <label class="form-label mt-2">Usuário</label>
      <div class="input-group" id="group-username">
        <span class="input-group-text"><i class="bi bi-person"></i></span>
        {{ form.username|add_class:"form-control" }}
      </div>
      <div id="username-msg"></div>
      {% if form.username.errors %}<div class="error-msg">{{ form.username.errors.0 }}</div>{% endif %}

      <!-- Email -->
      <label class="form-label mt-3">E-mail</label>
      <div class="input-group" id="group-email">
        <span class="input-group-text"><i class="bi bi-envelope"></i></span>
        {{ form.email|add_class:"form-control" }}
      </div>
      <div id="email-msg"></div>
      {% if form.email.errors %}<div class="error-msg">{{ form.email.errors.0 }}</div>{% endif %}

      <!-- CPF -->
      <label class="form-label mt-3">CPF</label>
      <div class="input-group" id="group-cpf">
        <span class="input-group-text"><i class="bi bi-card-text"></i></span>
        {{ form.cpf|add_class:"form-control" }}
      </div>
      <div id="cpf-msg"></div>
      {% if form.cpf.errors %}<div class="error-msg">{{ form.cpf.errors.0 }}</div>{% endif %}

      <!-- Telefone -->
      <label class="form-label mt-3">Telefone</label>
      <div class="input-group" id="group-telefone">
        <span class="input-group-text"><i class="bi bi-phone"></i></span>
        {{ form.telefone|add_class:"form-control" }}
      </div>
      <div id="telefone-msg"></div>
      {% if form.telefone.errors %}<div class="error-msg">{{ form.telefone.errors.0 }}</div>{% endif %}

      <!-- Senha -->
      <label class="form-label mt-3">Senha</label>
      <div class="input-group" id="group-pass1">
        <span class="input-group-text"><i class="bi bi-key"></i></span>
        {{ form.password1|add_class:"form-control"|attr:"autocomplete:new-password" }}
      </div>
      <div id="pass1-msg" class="small text-muted">Use 8+ caracteres, letra maiúscula, minúscula, número e símbolo.</div>
      {% if form.password1.errors %}<div class="error-msg">{{ form.password1.errors.0 }}</div>{% endif %}

      <!-- Confirmar Senha -->
      <label class="form-label mt-3">Confirmar Senha</label>
      <div class="input-group" id="group-pass2">
        <span class="input-group-text"><i class="bi bi-shield-lock"></i></span>
        {{ form.password2|add_class:"form-control"|attr:"autocomplete:new-password" }}
      </div>
      <div id="pass2-msg"></div>
      {% if form.password2.errors %}<div class="error-msg">{{ form.password2.errors.0 }}</div>{% endif %}

      <button class="btn btn-primary w-100 mt-4">
        <i class="bi bi-person-plus"></i> Criar Conta
      </button>

      <a href="{% url 'login' %}" class="btn btn-outline-primary w-100 mt-2">
        <i class="bi bi-box-arrow-in-right"></i> Já tenho uma conta
      </a>
    </form>

  </div>
</div>

<!-- SCRIPTS -->
<script>
/* ---------------------------------------------
   FEEDBACK VISUAL
--------------------------------------------- */
function setValid(group, msg, text="") {
  group.classList.remove("invalid");
  group.classList.add("valid");
  msg.innerHTML = text ? `<div class='success-msg'>${text}</div>` : "";
}
function setInvalid(group, msg, text) {
  group.classList.remove("valid");
  group.classList.add("invalid");
  msg.innerHTML = `<div class='error-msg'>${text}</div>`;
}

/* ---------------------------------------------
   MÁSCARA CPF
--------------------------------------------- */
function maskCPF(v) {
  v = v.replace(/\D/g, "");
  if (v.length <= 3) return v;
  if (v.length <= 6) return v.replace(/(\d{3})(\d+)/, "$1.$2");
  if (v.length <= 9) return v.replace(/(\d{3})(\d{3})(\d+)/, "$1.$2.$3");
  return v.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
}
document.getElementById("id_cpf").addEventListener("input", function () {
  this.value = maskCPF(this.value);
});

/* ---------------------------------------------
   MÁSCARA TELEFONE
--------------------------------------------- */
function maskTel(v) {
  v = v.replace(/\D/g, "");
  if (v.length <= 10) return v.replace(/(\d{2})(\d{4})(\d*)/, "($1) $2-$3");
  return v.replace(/(\d{2})(\d{5})(\d*)/, "($1) $2-$3");
}
document.getElementById("id_telefone").addEventListener("input", function () {
  this.value = maskTel(this.value);
});

/* ---------------------------------------------
   MÁSCARA EMAIL
--------------------------------------------- */
document.getElementById("id_email").addEventListener("input", function () {
  this.value = this.value.replace(/\s+/g, "").replace(/[^\w@\.\-]/g, "");
});

/* ---------------------------------------------
   MÁSCARA USERNAME
--------------------------------------------- */
document.getElementById("id_username").addEventListener("input", function () {
  this.value = this.value.replace(/\s+/g, "").replace(/[^\w\.\-]/g, "");
});

/* ---------------------------------------------
   VALIDAR USERNAME (AJAX)
--------------------------------------------- */
document.getElementById("id_username").addEventListener("blur", function() {
  const v = this.value.trim();
  const group = document.getElementById("group-username");
  const msg = document.getElementById("username-msg");

  if (v.length < 3) return setInvalid(group, msg, "Mínimo 3 caracteres.");

  fetch(`/validar/username/?u=${v}`)
    .then(r => r.json())
    .then(data =>
      data.exists
        ? setInvalid(group, msg, "Usuário indisponível.")
        : setValid(group, msg, "Usuário disponível!")
    );
});

/* ---------------------------------------------
   VALIDAR EMAIL (AJAX)
--------------------------------------------- */
document.getElementById("id_email").addEventListener("blur", function() {
  const v = this.value.trim();
  const group = document.getElementById("group-email");
  const msg = document.getElementById("email-msg");

  if (!v.includes("@") || v.length < 6)
    return setInvalid(group, msg, "E-mail inválido.");

  fetch(`/validar/email/?e=${v}`)
    .then(r => r.json())
    .then(data =>
      data.exists
        ? setInvalid(group, msg, "E-mail já cadastrado.")
        : setValid(group, msg, "E-mail disponível!")
    );
});

/* ---------------------------------------------
   VALIDAR CPF (AJAX)
--------------------------------------------- */
document.getElementById("id_cpf").addEventListener("blur", function() {
  const v = this.value.trim();
  const group = document.getElementById("group-cpf");
  const msg = document.getElementById("cpf-msg");

  fetch(`/validar/cpf/?cpf=${v}`)
    .then(r => r.json())
    .then(data =>
      data.exists
        ? setInvalid(group, msg, "CPF já cadastrado.")
        : setValid(group, msg, "CPF válido!")
    );
});

/* ---------------------------------------------
   VALIDAR SENHA (FORÇA)
--------------------------------------------- */
document.getElementById("id_password1").addEventListener("input", function() {
  const v = this.value;
  const group = document.getElementById("group-pass1");
  const msg = document.getElementById("pass1-msg");

  const forte = /^(?=.*[A-Z])(?=.*[a-z])(?=.*[0-9])(?=.*[!@#$%^&*()_\-+=]).{8,}$/;

  if (!forte.test(v))
    setInvalid(group, msg, "Senha fraca — use letra maiúscula, minúscula, número e símbolo.");
  else
    setValid(group, msg, "Senha forte!");
});

/* ---------------------------------------------
   CONFIRMAR SENHA
--------------------------------------------- */
document.getElementById("id_password2").addEventListener("input", function() {
  const p1 = document.getElementById("id_password1").value;
  const p2 = this.value;

  const group = document.getElementById("group-pass2");
  const msg = document.getElementById("pass2-msg");

  if (p1 !== p2) setInvalid(group, msg, "As senhas não coincidem.");
  else setValid(group, msg, "Senhas iguais!");
});

/* ---------------------------------------------
   CONFIRMAR ENVIO
--------------------------------------------- */
document.getElementById("cadastrarForm").addEventListener("submit", function(e) {
  if (!confirm("Deseja criar essa conta?")) e.preventDefault();
});
</script>

{% endblock %}
