{% extends "base.html" %}
{% block title %}Criar Prontuário{% endblock %}

{% block content %}

<style>
  body { background:#eef1f7; }

  .card-clean {
      border: none;
      border-radius: 18px;
      background: #fff;
      padding: 35px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.06);
  }

  .suggestions-box {
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      background: #ffffff;
      border: 1px solid #d6d9e4;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 999999;
      display: none;
      max-height: 260px;
      overflow-y: auto;
  }
  .suggestion-item { padding: 12px 15px; cursor: pointer; }
  .suggestion-item:hover { background: #e6ecff; }
</style>

<div class="container my-5" style="max-width:820px;">
  <div class="card-clean">

    {% include 'agendamento/componentes/paciente_header.html' with paciente=paciente %}

    <h4 class="section-title">Novo Prontuário</h4>

    <form method="POST" enctype="multipart/form-data" autocomplete="off">
      {% csrf_token %}

      <!-- Descrição geral -->
      <div class="mb-3">
        <label class="form-label">Descrição Geral</label>
        <textarea name="descricao" class="form-control campo-obrigatorio"
          placeholder="Ex.: Paciente relata dores há 3 dias, com piora ao caminhar..."
          rows="3" autocomplete="new-desc"></textarea>
      </div>

      <!-- Queixa Principal -->
      <div class="mb-3">
        <label class="form-label">Queixa Principal</label>
        <textarea name="queixa" class="form-control campo-obrigatorio"
          placeholder="Ex.: Dor abdominal, febre, tosse persistente, enjoo..."
          rows="2" autocomplete="new-queixa"></textarea>
      </div>

      <!-- Diagnóstico -->
      <div class="mb-3 position-relative">
        <label class="form-label">Diagnóstico</label>
        <input id="diagnostico" name="diagnostico" class="form-control campo-obrigatorio"
               placeholder="Ex.: Sinusite Aguda, Gastrite, Hipertensão..."
               autocomplete="new-diagnostico" autocorrect="off" autocapitalize="off">
        <div id="diagSugestoes" class="suggestions-box"></div>
      </div>

      <!-- CID -->
      <div class="mb-3 position-relative">
        <label class="form-label">CID</label>
        <input id="cid" name="cid" class="form-control"
               placeholder="Ex.: J01.0 — Sinusite aguda"
               autocomplete="new-cid">
        <div id="cidSugestoes" class="suggestions-box"></div>
      </div>

      <!-- Medicação -->
      <div class="mb-3 position-relative">
        <label class="form-label">Medicação Prescrita</label>
        <textarea id="medicacao" name="medicacao" class="form-control"
          placeholder="Ex.: Dipirona 1g de 6/6h, Amoxicilina 500mg de 8/8h..."
          rows="2" autocomplete="new-med"></textarea>
        <div id="medSugestoes" class="suggestions-box"></div>
      </div>

      <h4 class="section-title mt-4">Sinais Vitais</h4>

      <div class="row mb-2">
        <div class="col">
          <label class="form-label">Temperatura</label>
          <input id="temp" name="temperatura" class="form-control"
                 placeholder="Ex.: 37.5°C" autocomplete="new-temp">
        </div>
        <div class="col">
          <label class="form-label">Pressão Arterial</label>
          <input id="pressao" name="pressao" class="form-control"
                 placeholder="Ex.: 120/80 mmHg" autocomplete="new-pressao">
        </div>
        <div class="col">
          <label class="form-label">Saturação (%)</label>
          <input id="sat" name="saturacao" class="form-control"
                 placeholder="Ex.: 97%" autocomplete="new-sat">
        </div>
        <div class="col">
          <label class="form-label">Frequência Cardíaca</label>
          <input id="fc" name="frequencia_cardiaca" class="form-control"
                 placeholder="Ex.: 80 bpm" autocomplete="new-fc">
        </div>
      </div>

      <div class="mb-3">
        <label class="form-label">Frequência Respiratória</label>
        <input id="fr" name="frequencia_respiratoria" class="form-control"
               placeholder="Ex.: 18 irpm" autocomplete="new-fr">
      </div>

      <!-- Exame físico -->
      <div class="mb-3">
        <label class="form-label">Exame Físico</label>
        <textarea name="exame_fisico" class="form-control"
          placeholder="Ex.: Abdome flácido, sem dor à palpação, tórax simétrico..."
          rows="2" autocomplete="new-exf"></textarea>
      </div>

      <!-- Conduta -->
      <div class="mb-3">
        <label class="form-label">Conduta / Plano Terapêutico</label>
        <textarea name="conduta" class="form-control"
          placeholder="Ex.: Hidratação oral, repouso, prescrição de antibiótico..."
          rows="2" autocomplete="new-cond"></textarea>
      </div>

      <!-- Evolução -->
      <div class="mb-3">
        <label class="form-label">Evolução</label>
        <textarea name="evolucao" class="form-control"
          placeholder="Ex.: Paciente evolui bem, diminuição da dor, sinais estáveis..."
          rows="2" autocomplete="new-evo"></textarea>
      </div>

      <h4 class="section-title mt-4">Anexo</h4>

      <div class="file-box mb-3">
        <div class="file-icon mb-2"><i class="bi bi-upload"></i></div>
        <input type="file" name="anexo" class="form-control">
      </div>

      <div class="d-flex justify-content-between mt-4">
        <a href="javascript:history.back();" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Voltar
        </a>

        <button class="btn btn-primary">
          <i class="bi bi-save"></i> Salvar
        </button>
      </div>

    </form>
  </div>
</div>

<!-- SCRIPTS -->
<script>

/* ========================
   MÁSCARA — TEMPERATURA
========================= */
document.getElementById("temp").addEventListener("input", function (e) {
    let v = e.target.value.replace(/\D/g, "");
    if (v.length >= 3) {
        e.target.value = v.slice(0,2) + "." + v.slice(2,3) + "°C";
    } else {
        e.target.value = v;
    }
});

/* ========================
   MÁSCARA — PRESSÃO
========================= */
document.getElementById("pressao").addEventListener("input", function (e) {
    let v = e.target.value.replace(/\D/g,'');
    if (v.length > 5) v = v.slice(0,5);
    if (v.length >= 4)
        e.target.value = v.slice(0,3) + "/" + v.slice(3,5);
    else
        e.target.value = v;
});

/* ========================
   MÁSCARA — SATURAÇÃO
========================= */
document.getElementById("sat").addEventListener("input", function (e) {
    let v = e.target.value.replace(/\D/g,'');
    if (v.length > 3) v = v.slice(0,3);
    e.target.value = v + "%";
});

/* ========================
   MÁSCARA — FREQUÊNCIA CARDÍACA
========================= */
document.getElementById("fc").addEventListener("input", function (e) {
    let v = e.target.value.replace(/\D/g,'');
    if (v.length > 3) v = v.slice(0,3);
    e.target.value = v + " bpm";
});

/* ========================
   MÁSCARA — FREQUÊNCIA RESPIRATÓRIA
========================= */
document.getElementById("fr").addEventListener("input", function (e) {
    let v = e.target.value.replace(/\D/g,'');
    if (v.length > 2) v = v.slice(0,2);
    e.target.value = v + " irpm";
});

/* ========================
   MÁSCARA CID — A00.0
========================= */
document.getElementById("cid").addEventListener("input", function (e) {
    let v = e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'');
    if (v.length >= 4)
        e.target.value = v.slice(0,3) + "." + v.slice(3,4);
    else
        e.target.value = v;
});


/* ========================
   AUTOCOMPLETE
========================= */
const listaDiagnosticos = ["Sinusite Aguda","COVID-19","Gripe","Bronquite","Rinite","Pneumonia","Gastrite","Hipertensão","Otite","Amigdalite"];
const listaCID = ["J01.0","J45.0","K29.0","I10","J00","A09","E11"];
const listaMedicacoes = ["Dipirona 1g","Paracetamol 750mg","Ibuprofeno 600mg","Amoxicilina 500mg","Azitromicina 500mg","Losartana 50mg","Omeprazol 20mg","Prednisona 20mg"];

function autocomplete(campo, box, lista) {
  campo.addEventListener("input", () => {
    box.innerHTML = "";
    box.style.display = "none";
    const v = campo.value.toLowerCase();
    if (v.length < 2) return;
    const filtrados = lista.filter(x => x.toLowerCase().includes(v));
    filtrados.forEach(x => {
      const div = document.createElement("div");
      div.classList.add("suggestion-item");
      div.innerText = x;
      div.onclick = () => { campo.value = x; box.style.display = "none"; };
      box.appendChild(div);
    });
    if (filtrados.length) box.style.display = "block";
  });
}

autocomplete(document.getElementById("diagnostico"), diagSugestoes, listaDiagnosticos);
autocomplete(document.getElementById("cid"), cidSugestoes, listaCID);
autocomplete(document.getElementById("medicacao"), medSugestoes, listaMedicacoes);

</script>

{% endblock %}
