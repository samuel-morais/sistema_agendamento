{% extends 'base.html' %}
{% block title %}Meu Perfil{% endblock %}
{% block content %}

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-8">

      <div class="card shadow-lg border-0 rounded-4 overflow-hidden">
        <div class="card-header bg-primary text-white py-3">
          <h3 class="fw-bold"><i class="bi bi-person-circle me-2"></i> Meu Perfil</h3>
        </div>

        <div class="card-body p-4">

          {% if messages %}
            {% for m in messages %}
              <div class="alert alert-{{ m.tags }} alert-dismissible fade show">
                {{ m }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
              </div>
            {% endfor %}
          {% endif %}

          <form method="post" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="row g-4">

              <!-- USER -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Usuário</label>
                {{ form.username }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">E-mail</label>
                {{ form.email }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Nome</label>
                {{ form.first_name }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Sobrenome</label>
                {{ form.last_name }}
              </div>

              <!-- PACIENTE -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">CPF</label>
                {{ form.cpf }}
              </div>

              <div class="col-md-6">
                <label class="form-label fw-semibold">Telefone</label>
                {{ form.telefone }}
              </div>

              <div class="col-md-12">
                <label class="form-label fw-semibold">Endereço</label>
                {{ form.endereco }}
              </div>

              <div class="col-md-12">
                <label class="form-label fw-semibold">Convênio</label>
                {{ form.convenio }}
              </div>

              <!-- RG -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">RG</label>
                {{ form.rg }}
              </div>

              <!-- DATA NASCIMENTO -->
              <div class="col-md-6">
                <label class="form-label fw-semibold">Data de Nascimento</label>
                {{ form.data_nascimento }}
              </div>

              <!-- FOTO PERFIL -->
              <div class="col-md-12">
                <label class="form-label fw-semibold">Foto do Perfil</label>
                {{ form.foto }}

                {% if request.user.perfil_paciente and request.user.perfil_paciente.foto %}
                    <img src="{{ request.user.perfil_paciente.foto.url }}"
                         class="img-thumbnail mt-3"
                         style="width: 160px; border-radius: 12px;">
                {% endif %}
              </div>

            </div>

            <div class="d-flex justify-content-between mt-4">
              <a href="{% url 'password_change' %}" class="btn btn-outline-secondary btn-lg">
                <i class="bi bi-lock"></i> Alterar Senha
              </a>

              <button class="btn btn-success btn-lg">
                <i class="bi bi-save2 me-1"></i> Salvar Alterações
              </button>
            </div>

          </form>

        </div>
      </div>

    </div>
  </div>
</div>

<style>
body { background:#f3f7ff; }
.card { border-radius:1rem; }
.form-control-lg { border-radius:.6rem; }
.form-control-lg:focus { border-color:#0d6efd; box-shadow:0 0 0 .2rem rgba(13,110,253,.25); }
.btn-lg { border-radius:.5rem; }
.btn-success:hover { transform:translateY(-2px); }
</style>

<script>
document.addEventListener("DOMContentLoaded", function() {

    function limparNumero(valor) {
        return valor.replace(/\D/g, "");
    }

    function aplicarMascaraCPF(valor) {
        valor = limparNumero(valor).slice(0, 11);
        if (valor.length <= 3) return valor;
        if (valor.length <= 6) return valor.replace(/(\d{3})(\d+)/, "$1.$2");
        if (valor.length <= 9) return valor.replace(/(\d{3})(\d{3})(\d+)/, "$1.$2.$3");
        return valor.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, "$1.$2.$3-$4");
    }

    function aplicarMascaraTelefone(valor) {
        valor = limparNumero(valor).slice(0, 11);
        if (valor.length < 3) return valor;
        if (valor.length < 7) return valor.replace(/(\d{2})(\d+)/, "($1) $2");
        if (valor.length === 10) return valor.replace(/(\d{2})(\d{4})(\d{4})/, "($1) $2-$3");
        return valor.replace(/(\d{2})(\d{5})(\d{4})/, "($1) $2-$3");
    }

    function aplicarEventoMascara(input, mascaraFunc) {
        if (!input) return;
        input.addEventListener("input", function(e) {
            let posicao = input.selectionStart;
            input.value = mascaraFunc(input.value);
            input.setSelectionRange(posicao, posicao);
        });
    }

    aplicarEventoMascara(document.querySelector("input[name='cpf']"), aplicarMascaraCPF);
    aplicarEventoMascara(document.querySelector("input[name='telefone']"), aplicarMascaraTelefone);

});
</script>

{% endblock %}
