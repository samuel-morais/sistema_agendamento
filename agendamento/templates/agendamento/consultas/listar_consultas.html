{% extends "base.html" %}
{% block title %}Consultas{% endblock %}

{% block content %}

<div class="container my-5">

  <!-- ===============================
        BOTÃO VOLTAR
  ================================ -->
  <a href="javascript:history.back()" class="btn btn-outline-primary mb-4">
    <i class="bi bi-arrow-left"></i> Voltar
  </a>

  <!-- ===============================
        TÍTULO + NOVA CONSULTA (Pacientes)
  ================================ -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">
      <i class="bi bi-calendar2-heart me-2"></i> Consultas
    </h2>

    {% if is_usuario_padrao %}
    <a href="{% url 'criar_consulta' %}" class="btn btn-primary fw-semibold shadow-sm">
      <i class="bi bi-plus-lg me-1"></i> Nova Consulta
    </a>
    {% endif %}
  </div>

  <!-- ===============================
        MENSAGENS
  ================================ -->
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm" role="alert">
        <i class="bi bi-info-circle me-2"></i>{{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}

  <!-- ===============================
        TABELA DE CONSULTAS
  ================================ -->
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body p-4">

      {% if consultas %}
      <div class="table-responsive">
        <table class="table align-middle table-hover text-center">

          <thead class="table-primary text-white">
            <tr>
              <th>Paciente</th>
              <th>Médico</th>
              <th>Especialidade</th>
              <th>Convênio</th>
              <th>Data e Hora</th>
              <th>Duração</th>
              <th>Status</th>
              <th class="text-end">Ações</th>
            </tr>
          </thead>

          <tbody>

          {% for consulta in consultas %}
          <tr>

            <!-- PACIENTE -->
            <td class="fw-semibold text-start ps-3">
              {{ consulta.paciente.nome }}
            </td>

            <!-- MÉDICO -->
            <td>
              {{ consulta.medico.user.get_full_name }}
            </td>

            <!-- ESPECIALIDADE -->
            <td>
              <span class="badge bg-info text-dark px-3 py-2">
                {{ consulta.medico.especialidade.nome }}
              </span>
            </td>

            <!-- CONVÊNIO -->
            <td>
              {% if consulta.usa_convenio %}
                <span class="badge bg-success px-3 py-2">
                  ✔ {{ consulta.convenio.nome }}
                </span>
              {% else %}
                <span class="badge bg-secondary px-3 py-2">Não</span>
              {% endif %}
            </td>

            <!-- DATA E HORA -->
            <td class="fw-semibold text-primary">
              {{ consulta.data_hora|date:"d/m/Y H:i" }}
            </td>

            <!-- DURAÇÃO -->
            <td>{{ consulta.duracao_minutos }} min</td>

            <!-- STATUS -->
            <td>
              {% if consulta.status == 'confirmada' %}
                <span class="badge bg-success px-3 py-2">
                  <i class="bi bi-check2-circle me-1"></i> Confirmada
                </span>

              {% elif consulta.status == 'cancelada' %}
                <span class="badge bg-danger px-3 py-2">
                  <i class="bi bi-x-circle me-1"></i> Cancelada
                </span>

              {% else %}
                <span class="badge bg-warning text-dark px-3 py-2">
                  <i class="bi bi-clock-history me-1"></i> Agendada
                </span>
              {% endif %}
            </td>

            <!-- AÇÕES -->
            <td class="text-end pe-3">
              <div class="btn-group gap-1">

                <!-- EDITAR -->
                <a href="{% url 'editar_consulta' consulta.id %}"
                   class="btn btn-sm btn-outline-warning">
                  <i class="bi bi-pencil-square"></i>
                </a>

                <!-- EXCLUIR -->
                <a href="{% url 'excluir_consulta' consulta.id %}"
                   class="btn btn-sm btn-outline-danger">
                  <i class="bi bi-trash3"></i>
                </a>

                <!-- CANCELAR -->
                {% if consulta.status == 'agendada' %}
                <form method="post" action="{% url 'cancelar_consulta' consulta.id %}">
                  {% csrf_token %}
                  <button class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-slash-circle"></i>
                  </button>
                </form>
                {% endif %}

              </div>
            </td>

          </tr>
          {% endfor %}

          </tbody>
        </table>
      </div>

      {% else %}
      <!-- LISTA VAZIA -->
      <div class="text-center py-5 text-muted">
        <i class="bi bi-calendar-x display-4 d-block mb-3"></i>
        <h5>Nenhuma consulta encontrada</h5>

        {% if is_usuario_padrao %}
        <a href="{% url 'criar_consulta' %}" class="btn btn-primary mt-3">
          <i class="bi bi-plus-lg me-1"></i> Criar nova consulta
        </a>
        {% endif %}

      </div>
      {% endif %}

    </div>
  </div>
</div>

<!-- ===============================
        ESTILO LOCAL
=============================== -->
<style>
.table-primary {
  background: linear-gradient(90deg, #0d6efd, #2563eb);
}
.table-hover tbody tr:hover {
  background-color: rgba(13, 110, 253, 0.08);
}
.badge {
  font-size: 0.85rem;
}
</style>

{% endblock %}
