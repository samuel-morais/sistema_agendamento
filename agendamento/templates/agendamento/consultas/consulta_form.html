{% extends "base.html" %}
{% load static %}
{% block title %}{{ titulo }}{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'css/consulta_form.css' %}">
<script src="{% static 'js/consulta_form.js' %}" defer></script>

<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow-lg border-0 rounded-4" id="cardConsulta">
        <div class="card-header text-white rounded-top-4"
             style="background: linear-gradient(90deg, #0d6efd, #00b4d8);">
          <h3 class="mb-0 fw-semibold">
            <i class="bi bi-calendar2-check me-2"></i>{{ titulo }}
          </h3>
        </div>

        <div class="card-body p-4">

          <div class="alert alert-info py-2 mb-4">
            <strong>Paciente:</strong>
            {{ request.user.get_full_name|default:request.user.username }} (vocÃª)
          </div>

          <!-- Mensagens de Erro -->
          <div id="mensagem-erro" class="alert alert-danger d-none mb-4"></div>

          <!-- CAMPOS OCULTOS PARA MODO EDIÃ‡ÃƒO -->
          <input type="hidden" id="isEdicao" value="{% if consulta %}1{% else %}0{% endif %}">
          <input type="hidden" id="consultaEspecialidade"
                 value="{% if consulta %}{{ consulta.medico.especialidade.id }}{% endif %}">
          <input type="hidden" id="consultaMedico"
                 value="{% if consulta %}{{ consulta.medico.id }}{% endif %}">
          <input type="hidden" id="consultaData"
                 value="{% if consulta %}{{ consulta.data_hora.date }}{% endif %}">
          <input type="hidden" id="consultaHora"
                 value="{% if consulta %}{{ consulta.data_hora.time|time:'H:i' }}{% endif %}">
          <input type="hidden" id="consultaConvenio"
                 value="{% if consulta and consulta.convenio %}{{ consulta.convenio.id }}{% endif %}">
          <input type="hidden" id="consultaUsaConvenio"
                 value="{% if consulta and consulta.usa_convenio %}1{% else %}0{% endif %}">

          <!-- FORM -->
          <form method="post" id="consultaForm" novalidate>
            {% csrf_token %}

            <!-- Especialidade -->
            <div class="mb-3">
              <label class="form-label fw-semibold">
                <i class="bi bi-hospital"></i> Especialidade
              </label>
              <select id="especialidadeSelect" name="especialidade" class="form-select">
                <option value="">Selecione uma especialidade</option>
                {% for esp in especialidades %}
                <option value="{{ esp.id }}"
                    {% if consulta and consulta.medico.especialidade.id == esp.id %}selected{% endif %}>
                    {{ esp.nome }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- MÃ©dico -->
            <div class="mb-3">
              <label class="form-label fw-semibold">
                <i class="bi bi-person-badge"></i> MÃ©dico
              </label>
              {{ form.medico }}
            </div>

            <!-- Checkbox convÃªnio -->
            <div class="mb-3 form-check">
              <input class="form-check-input" type="checkbox" id="usa_convenio" name="usa_convenio">
              <label class="form-check-label" for="usa_convenio">
                <i class="bi bi-card-checklist me-1"></i> Consulta por convÃªnio?
              </label>
            </div>

            <!-- Select convÃªnio -->
            <div class="mb-3" id="wrapper_convenio" style="display:none;">
              <label class="form-label fw-semibold">
                <i class="bi bi-list-check"></i> Selecione o convÃªnio
              </label>
              <select id="select_convenio" name="convenio" class="form-select">
                <option value="">Selecione o convÃªnio</option>
                {% for c in convenios %}
                <option value="{{ c.id }}"
                    {% if consulta and consulta.convenio and consulta.convenio.id == c.id %}
                    selected
                    {% endif %}>
                    {{ c.nome }}
                </option>
                {% endfor %}
              </select>
            </div>

            <!-- Data -->
            <div class="mb-4">
              <label class="form-label fw-semibold mb-2">
                <i class="bi bi-calendar-week"></i> Escolha o dia
              </label>
              <div class="position-relative date-wrapper">
                <i class="bi bi-calendar4-week date-icon"></i>
                <input type="date" id="data-futura" name="data"
                       class="form-control date-input blocked-date"
                       readOnly required>
              </div>
            </div>

            <!-- HorÃ¡rios -->
            <div class="mb-4">
              <label class="form-label fw-semibold">
                <i class="bi bi-clock-history"></i> Escolha o horÃ¡rio
              </label>

              <div id="grade-horarios" class="d-grid"
                   style="grid-template-columns: repeat(auto-fill, minmax(110px, 1fr)); gap: 8px;">
                <span class="text-muted small">Selecione o mÃ©dico e o dia.</span>
              </div>

              <input type="hidden" name="hora" id="id_hora">
              <input type="hidden" name="data_hora" id="id_data_hora">
              <input type="hidden" name="duracao_minutos" value="30">
              <input type="hidden" name="status" value="agendada">
              <input type="hidden" name="confirmada" value="True">
            </div>

            <!-- ObservaÃ§Ãµes -->
            <div class="mb-3">
              <label class="form-label fw-semibold">
                <i class="bi bi-pencil-square"></i> ObservaÃ§Ãµes
              </label>
              {{ form.observacoes }}
            </div>

            <!-- BotÃµes -->
            <div class="d-flex justify-content-end gap-2 mt-4">
              <a href="{% url 'listar_consultas' %}"
                 class="btn btn-outline-secondary fw-semibold">
                <i class="bi bi-arrow-left"></i> Voltar
              </a>

              <button type="submit"
                      class="btn btn-success fw-semibold"
                      id="btnConfirmar" disabled>
                <span id="btn-texto">
                  <i class="bi bi-check2-circle me-1"></i> Confirmar Consulta
                </span>
                <span id="btn-spinner"
                      class="spinner-border spinner-border-sm d-none"></span>
              </button>
            </div>

          </form>
        </div>

      </div>
    </div>

  </div>
</div>


<!-- ======================================================= -->
<!-- ðŸ‘‡ MODAL DE RESUMO DA CONSULTA (INCLUIDO AQUI) -->
<!-- ======================================================= -->
<div class="modal fade" id="modalResumo" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content rounded-4 shadow">

      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title fw-semibold">
          <i class="bi bi-clipboard-check me-2"></i>Resumo da Consulta
        </h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body p-3">
        <p><strong>Paciente:</strong> <span id="resPaciente"></span></p>
        <p><strong>MÃ©dico:</strong> <span id="resMedico"></span></p>
        <p><strong>Especialidade:</strong> <span id="resEspecialidade"></span></p>
        <p><strong>Data:</strong> <span id="resData"></span></p>
        <p><strong>HorÃ¡rio:</strong> <span id="resHora"></span></p>
        <p><strong>ConvÃªnio:</strong> <span id="resConvenio"></span></p>
      </div>

      <div class="modal-footer">
        <button class="btn btn-success fw-semibold" id="btnModalOk">
          OK, continuar
        </button>
      </div>

    </div>
  </div>
</div>

{% endblock %}
