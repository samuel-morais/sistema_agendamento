{% extends "base.html" %}
{% block title %}Notificações{% endblock %}

{% block content %}
<div class="container my-5">

  <!-- BOTÃO VOLTAR -->
  <a href="javascript:history.back()" class="btn btn-outline-primary mb-4">
    <i class="bi bi-arrow-left"></i> Voltar
  </a>

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold text-primary">
      <i class="bi bi-bell me-2"></i> Notificações
    </h2>

    <div>
      <a href="{% url 'listar_notificacoes' %}" class="btn btn-sm btn-outline-primary">Todas</a>
      <a href="{% url 'listar_notificacoes' %}?f=unread" class="btn btn-sm btn-outline-warning">Não lidas</a>
      <a href="{% url 'listar_notificacoes' %}?f=read" class="btn btn-sm btn-outline-success">Lidas</a>
    </div>
  </div>

  {% if notificacoes %}
    <ul class="list-unstyled">
      {% for n in notificacoes %}
        <li class="mb-3">
          <div class="card shadow-sm {% if not n.lida %}border-primary{% endif %}">
            <div class="card-body d-flex justify-content-between align-items-start">

              <div style="max-width:80%;">
                <strong>{{ n.titulo }}</strong><br>
                <div class="small text-muted">{{ n.mensagem }}</div>
                <div class="small text-muted mt-1">
                  {{ n.criado_em|date:"d/m/Y H:i" }}
                </div>
              </div>

              <div class="text-end">

                <!-- BOTÃO ABRIR — Agora usa link real da notificação -->
                <a href="{{ n.link|default:'#' }}" class="btn btn-sm btn-outline-primary mb-2">
                  Abrir
                </a><br>

                <!-- MARCAR COMO LIDA -->
                {% if not n.lida %}
                  <button class="btn btn-sm btn-primary btn-mark-read" data-id="{{ n.id }}">
                    Marcar lida
                  </button>
                {% else %}
                  <span class="badge bg-success">Lida</span>
                {% endif %}
              </div>

            </div>
          </div>
        </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-muted">Nenhuma notificação encontrada.</p>
  {% endif %}

</div>

<!-- JS MARCAR COMO LIDA -->
<script>
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let c of cookies) {
      c = c.trim();
      if (c.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(c.slice(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.btn-mark-read').forEach(btn => {

    btn.addEventListener('click', () => {
      const id = btn.dataset.id;
      const csrf = getCookie('csrftoken') || getCookie('csrfmiddlewaretoken');

      fetch(
        "{% url 'notificacoes_marcar_lida' 0 %}".replace('/0/', `/${id}/`),
        {
          method: "POST",
          credentials: "same-origin",
          headers: { "X-CSRFToken": csrf }
        }
      ).then(res => {
        if (res.ok) location.reload();
      });

    });

  });
});
</script>

{% endblock %}
