{% extends "base.html" %}
{% load static %}

{% block title %}Login{% endblock %}

{% block content %}
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

  html, body {
    height: 100%;
    font-family: 'Inter', sans-serif;
  }

  body {
    background: linear-gradient(135deg, #4e54c8, #8f94fb);
  }

  .login-page {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    padding: 1rem;
  }

  .login-card {
    background: #fff;
    border-radius: 1rem;
    padding: 3rem 2rem;
    max-width: 400px;
    width: 100%;
    text-align: center;
    box-shadow: 0 10px 40px rgba(0,0,0,0.15);
    transition: all 0.3s ease;
  }

  .login-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 15px 50px rgba(0,0,0,0.25);
  }

  .login-logo img {
    max-width: 120px;
    margin-bottom: 1rem;
    animation: logoBounce 1s ease;
  }

  @keyframes logoBounce {
    0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
    40% { transform: translateY(-10px); }
    60% { transform: translateY(-5px); }
  }

  .input-group.valid { border: 2px solid #28a745; }
  .input-group.invalid { border: 2px solid #dc3545; }

  .error-msg {
    color: #dc3545;
    font-size: .85rem;
    margin-top: 4px;
    text-align: left;
  }

  .success-msg {
    color: #28a745;
    font-size: .85rem;
    margin-top: 4px;
    text-align: left;
  }

  .btn-primary {
    background: #4e54c8;
    border: none;
    padding: 0.6rem 0;
    font-weight: 600;
    transition: all 0.3s;
  }

  .btn-primary.loading {
    opacity: .8;
    pointer-events: none;
  }

  .btn-primary:hover {
    background: #8f94fb;
    transform: translateY(-2px);
  }

  .show-password {
    cursor: pointer;
    color: #4e54c8;
  }

</style>

<div class="login-page">
  <div class="login-card">

    <div class="login-logo">
      <img src="{% static 'images/logo.png' %}" alt="Logo">
    </div>

    <h3>üîê Acessar o Sistema</h3>

    {% if messages %}
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">{{ message }}</div>
      {% endfor %}
    {% endif %}

    <form method="post" id="loginForm" novalidate>
      {% csrf_token %}

      <!-- Usu√°rio -->
      <div class="mb-3 text-start">
        <label for="id_username" class="form-label">Usu√°rio</label>
        <div class="input-group" id="group-username">
          <span class="input-group-text">üë§</span>
          <input type="text" name="username" id="id_username" class="form-control" required autofocus>
        </div>
        <div id="username-msg"></div>
      </div>

      <!-- Senha -->
      <div class="mb-3 text-start">
        <label for="id_password" class="form-label">Senha</label>
        <div class="input-group" id="group-password">
          <span class="input-group-text">üîë</span>
          <input type="password" name="password" id="id_password" class="form-control" required>
          <span class="input-group-text show-password" id="togglePass">üëÅ</span>
        </div>
        <div id="password-msg"></div>
      </div>

      <button type="submit" class="btn btn-primary w-100" id="btnLogin">
        <span id="btnText">Entrar</span>
        <span id="btnSpinner" class="spinner-border spinner-border-sm d-none"></span>
      </button>

      <p class="text-center mt-3">
        <a href="{% url 'cadastrar_usuario' %}" class="text-decoration-none">Criar uma conta</a>
      </p>

    </form>

    <p class="text-muted small mt-3 mb-0">¬© {{ now|date:"Y" }} Sistema de Agendamento</p>
  </div>
</div>

<script>
/* Mostrar / Ocultar Senha */
document.getElementById("togglePass").addEventListener("click", function () {
  const field = document.getElementById("id_password");
  field.type = field.type === "password" ? "text" : "password";
});

/* Valida√ß√£o Username (AJAX) */
document.getElementById("id_username").addEventListener("blur", function () {
  const user = this.value.trim();
  const group = document.getElementById("group-username");
  const msg = document.getElementById("username-msg");

  if (!user) {
    group.classList.add("invalid");
    msg.innerHTML = `<div class="error-msg">Informe o usu√°rio.</div>`;
    return;
  }

  fetch("/validar/username/?u=" + user)
    .then(r => r.json())
    .then(data => {
      if (!data.exists) {
        group.classList.add("invalid");
        group.classList.remove("valid");
        msg.innerHTML = `<div class="error-msg">Usu√°rio n√£o encontrado.</div>`;
      } else {
        group.classList.remove("invalid");
        group.classList.add("valid");
        msg.innerHTML = `<div class="success-msg">Usu√°rio encontrado.</div>`;
      }
    });
});

/* Valida√ß√£o simples de senha */
document.getElementById("id_password").addEventListener("input", function () {
  const val = this.value.trim();
  const group = document.getElementById("group-password");
  const msg = document.getElementById("password-msg");

  if (val.length < 3) {
    group.classList.add("invalid");
    msg.innerHTML = `<div class="error-msg">Senha muito curta.</div>`;
  } else {
    group.classList.remove("invalid");
    group.classList.add("valid");
    msg.innerHTML = ``;
  }
});

/* Loader ao enviar form */
document.getElementById("loginForm").addEventListener("submit", function () {
  const btn = document.getElementById("btnLogin");
  const text = document.getElementById("btnText");
  const spin = document.getElementById("btnSpinner");

  btn.classList.add("loading");
  text.innerHTML = "Entrando...";
  spin.classList.remove("d-none");
});
</script>

{% endblock %}
