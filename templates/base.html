{% load static %}
<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Sistema de Agendamento{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap + √çcones -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

<style>

/* ================================
      VARI√ÅVEIS DE TEMA
================================ */
:root{
  --primary-500: #2563eb;
  --primary-600: #1e4fd6;
  --bg: #f5f8ff;
  --card-bg: #ffffff;
  --muted: #7a7f86;
  --accent: #0b5ed7;
}

/* ================================
      BODY
================================ */
body {
  background: radial-gradient(circle at 10% 10%, rgba(37,99,235,0.06), transparent 20%),
              linear-gradient(180deg,#f8fbff 0%, #f3f6ff 100%);
  font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  color: #222;
}

/* ================================
      NAVBAR
================================ */
.navbar {
  background: linear-gradient(90deg, var(--primary-500), var(--primary-600));
  padding: .6rem 1rem;
  box-shadow: 0 6px 20px rgba(16,24,40,0.08);
}
.navbar .navbar-brand { color: #fff; }
.navbar .nav-link { color: rgba(255,255,255,0.95); opacity: .95; }
.nav-role { color: rgba(255,255,255,0.85); font-size:.82rem; display:block; }

/* ================================
      DASHBOARD CARDS
================================ */
.dashboard-card {
  padding: 1.4rem 1.1rem;
  border-radius: 12px;
  color: white!important;
  background: linear-gradient(135deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
  box-shadow: 0 8px 28px rgba(16,24,40,0.06);
  min-height: 150px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  transition: transform .18s ease, box-shadow .18s ease;
}
.dashboard-card:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 40px rgba(16,24,40,0.08);
}

/* CORES */
.bg-gradient-primary { background: linear-gradient(135deg, #1e90ff, #2563eb) !important; }
.bg-gradient-success { background: linear-gradient(135deg, #16a34a, #059669) !important; }
.bg-gradient-info { background: linear-gradient(135deg, #0ea5e9, #0284c7) !important; }
.bg-gradient-secondary { background: linear-gradient(135deg, #4b5563, #374151) !important; }

/* ================================
      NOTIFICA√á√ïES
================================ */
.notif-badge {
  position: absolute;
  top: -6px;
  right: -6px;
  font-size: .65rem;
  padding: 3px 6px;
  border-radius: 999px;
  background:#ff4d4f;
  color:#fff;
}

.dropdown-notif-list { max-height: 340px; overflow:auto; padding: .35rem; }
.dropdown-notif-list .dropdown-item { border-radius:6px; margin-bottom:.35rem; }
.notif-item-unread { background:#eef6ff !important; }

/* üîî Sino vermelho quando tiver notifica√ß√µes */
.bell-has-notif {
  color:#ff4d4f !important;
  animation:pulse-bell 1.6s infinite;
}
@keyframes pulse-bell {
  0% { transform:scale(1); }
  50% { transform:scale(1.18); }
  100% { transform:scale(1); }
}

</style>

{% block extra_head %}{% endblock %}
</head>
<body>

{% if user.is_authenticated %}

<!-- ================================
            NAVBAR
================================ -->
<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid px-4">

    <!-- LOGO -->
    <a class="navbar-brand d-flex align-items-center gap-3" href="{% url 'pagina_inicial' %}">
      <img src="{% static 'images/logo.png' %}" height="36" alt="logo">
      <div>
        <strong style="font-size:1.05rem;color:#fff;">Sistema de Agendamento</strong>

        <span class="nav-role">
          {% if user.is_superuser %}
            Super Administrador
          {% elif user.is_staff and not is_medico_user %}
            Administrador
          {% elif is_medico_user %}
            M√©dico
          {% elif is_usuario_padrao %}
            Usu√°rio
          {% else %}
            Funcion√°rio
          {% endif %}
        </span>
      </div>
    </a>

    <!-- BOT√ÉO MOBILE -->
    <button class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navmenu">
      <span class="navbar-toggler-icon"></span>
    </button>

    <!-- MENU -->
    <div id="navmenu" class="collapse navbar-collapse justify-content-end">
      <ul class="navbar-nav align-items-center gap-3">

        <!-- HOME -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'pagina_inicial' %}">
            <i class="bi bi-house-door me-1"></i> P√°gina Inicial
          </a>
        </li>

        <!-- CONSULTAS -->
        <li class="nav-item">
          <a class="nav-link" href="{% url 'listar_consultas' %}">
            <i class="bi bi-calendar-check me-1"></i> Consultas
          </a>
        </li>

        {% if is_usuario_padrao %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'criar_consulta' %}">
            <i class="bi bi-plus-circle me-1"></i> Agendar
          </a>
        </li>
        {% endif %}

        {% if is_medico_user %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'listar_pacientes' %}">
            <i class="bi bi-people-fill me-1"></i> Meus Pacientes
          </a>
        </li>
        {% endif %}

        {% if user.is_staff and not is_medico_user %}
        <li class="nav-item">
          <a class="nav-link" href="{% url 'listar_medicos' %}">
            <i class="bi bi-person-badge me-1"></i> M√©dicos
          </a>
        </li>
        {% endif %}

        <!-- ================================
              NOTIFICA√á√ïES DROPDOWN
        ================================= -->
        <li class="nav-item dropdown position-relative">
          <a id="notifToggle" class="nav-link position-relative" data-bs-toggle="dropdown">
            <i id="notif-bell" class="bi bi-bell" style="font-size:1.25rem;"></i>
            <span id="notif-count" class="notif-badge d-none">0</span>
          </a>

          <div class="dropdown-menu dropdown-menu-end shadow-sm p-3"
               style="min-width:380px;" id="notif-dropdown">

            <div class="d-flex align-items-center justify-content-between mb-2">
              <h6 class="mb-0"><i class="bi bi-bell-fill me-2"></i> Notifica√ß√µes</h6>
              <small class="text-muted-small">Recentes</small>
            </div>

            <!-- TABS -->
            <div class="d-flex gap-2 mb-2">
              <button id="notif-tab-all" class="btn btn-sm btn-outline-primary">Todas</button>
              <button id="notif-tab-unread" class="btn btn-sm btn-outline-warning">N√£o lidas</button>
              <button id="notif-tab-read" class="btn btn-sm btn-outline-success">Lidas</button>
            </div>

            <!-- LISTA -->
            <div class="dropdown-notif-list" id="notif-list-container">
              <div id="notif-list-empty" class="text-muted text-center small">Carregando...</div>
              <ul id="notif-items" class="list-unstyled mb-0 p-0"></ul>
            </div>

            <div class="dropdown-divider my-2"></div>
            <div class="text-center small">
              <a href="{% url 'listar_notificacoes' %}">Ver todas notifica√ß√µes</a>
            </div>

          </div>
        </li>

        <!-- AVATAR -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle d-flex align-items-center gap-2" data-bs-toggle="dropdown">
            {% if user.is_authenticated %}

           {% if user.perfil_paciente and user.perfil_paciente.foto %}
             <img src="{{ user.perfil_paciente.foto.url }}"
             class="rounded-circle"
             width="40" height="40"
             style="object-fit: cover;">
          {% else %}
            <img src="{% static 'images/default_user.png' %}"
             class="rounded-circle"
             width="40" height="40"
             style="object-fit: cover;">
           {% endif %}

          {% endif %}


            <span class="text-white" style="max-width:160px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
              {{ user.get_full_name|default:user.username }}
            </span>
          </a>

          <ul class="dropdown-menu dropdown-menu-end shadow-sm">
            <li class="dropdown-header text-center">
              <strong>{{ user.get_full_name|default:user.username }}</strong>
              <div class="small text-muted">{{ user.email }}</div>
              <div class="small text-muted mt-1">
                {% if user.is_superuser %}Super Administrador
                {% elif user.is_staff %}Administrador
                {% elif is_medico_user %}M√©dico
                {% elif is_usuario_padrao %}Usu√°rio
                {% else %}Funcion√°rio{% endif %}
              </div>
            </li>

            <li><hr></li>

            <li><a class="dropdown-item" href="{% url 'perfil_usuario' %}">
              <i class="bi bi-person-circle me-2"></i> Meu Perfil</a></li>

            {% if user.is_superuser %}
            <li><a class="dropdown-item" href="/admin/">
              <i class="bi bi-gear me-2"></i> Painel Admin</a></li>
            {% endif %}

            <li><hr></li>
            <li>
              <form method="post" action="{% url 'logout' %}">{% csrf_token %}
                <button class="dropdown-item text-danger fw-semibold">
                  <i class="bi bi-box-arrow-right me-2"></i> Sair
                </button>
              </form>
            </li>
          </ul>
        </li>

      </ul>
    </div>
  </div>
</nav>

{% endif %}

<!-- ================================
            CONTE√öDO
================================ -->
<div class="container py-4">
  {% block content %}{% endblock %}
</div>

<!-- ================================
            FOOTER
================================ -->
<footer class="text-center mt-4 py-3">
  ¬© {{ now|date:"Y" }} Sistema de Agendamento ‚Äî Todos os direitos reservados.
</footer>

<!-- Bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% block extra_scripts %}
{% if user.is_authenticated %}
<script>

/* =============================
   UTIL ‚Äî COOKIE / CSRF
============================= */
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let c of cookies) {
      const cookie = c.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

/* =============================
   NOTIFICA√á√ïES ‚Äî CONFIG
============================= */
document.addEventListener("DOMContentLoaded", () => {

  const COUNT_URL = "{% url 'notificacoes_count' %}";
  const LIST_URL  = "{% url 'notificacoes_list' %}";
  const NOVAS_URL = "{% url 'notificacoes_novas' %}";
  const MARCAR_LIDA_TPL = "{% url 'notificacoes_marcar_lida' 0 %}";

  const badge = document.getElementById("notif-count");
  const notifBell = document.getElementById("notif-bell");
  const emptyEl = document.getElementById("notif-list-empty");
  const itemsContainer = document.getElementById("notif-items");
  const notifToggle = document.getElementById("notifToggle");

  const tabAll    = document.getElementById("notif-tab-all");
  const tabUnread = document.getElementById("notif-tab-unread");
  const tabRead   = document.getElementById("notif-tab-read");

  let cached = [];
  let currentFilter = "all";
  let lastCount = 0;

  /* -------------------------
     RENDER BADGE / SINO
  --------------------------*/
  function renderBadge(count) {
    if (!badge) return;
    if (count > 0) {
      badge.textContent = count > 99 ? "99+" : String(count);
      badge.classList.remove("d-none");
      notifBell.classList.add("bell-has-notif");
    } else {
      badge.classList.add("d-none");
      notifBell.classList.remove("bell-has-notif");
    }
  }

  /* -------------------------
     CRIA ITEM DOM
  --------------------------*/
  function buildItem(n) {
    const unread = n.lida ? "" : "notif-item-unread";
    const li = document.createElement("li");

    // se existir link, abrimos ap√≥s marcar lida
    li.innerHTML = `
      <a class="dropdown-item d-flex justify-content-between align-items-start ${unread}" href="${n.link || '#'}">
        <div style="max-width:72%;">
          <strong class="small d-block text-truncate">${n.titulo}</strong>
          <div class="small text-muted text-truncate">${n.mensagem}</div>
          <div class="small text-muted mt-1">${n.criado_em}</div>
        </div>

        <div class="text-end">
          <button type="button" class="btn btn-sm btn-outline-primary btn-view" data-id="${n.id}" data-link="${n.link || ''}">
            Abrir
          </button>
        </div>
      </a>
    `;
    return li;
  }

  /* -------------------------
     RENDERIZA LISTA
  --------------------------*/
  function renderList(list) {
    cached = [...list];
    itemsContainer.innerHTML = "";

    const filtered = cached.filter(n =>
      currentFilter === "all" ? true :
      currentFilter === "unread" ? !n.lida :
      n.lida
    );

    if (!filtered.length) {
      emptyEl.classList.remove("d-none");
      emptyEl.textContent = currentFilter === "unread" ? "Nenhuma notifica√ß√£o n√£o lida." : "Nenhuma notifica√ß√£o.";
      return;
    }

    emptyEl.classList.add("d-none");
    filtered.forEach(n => itemsContainer.appendChild(buildItem(n)));

    // adiciona eventos aos bot√µes Abrir
    itemsContainer.querySelectorAll(".btn-view").forEach(btn => {
      btn.addEventListener("click", async (ev) => {
        ev.preventDefault();
        ev.stopPropagation();

        const id = btn.dataset.id;
        const link = btn.dataset.link || '';
        const csrftoken = getCookie("csrftoken") || getCookie("csrf_token") || getCookie("csrfmiddlewaretoken");
        const url = MARCAR_LIDA_TPL.replace("/0/", `/${id}/`);

        try {
          const res = await fetch(url, {
            method: "POST",
            credentials: "same-origin",
            headers: { "X-CSRFToken": csrftoken }
          });

          if (res.ok) {
            // Atualiza cache local e UI
            const idx = cached.findIndex(n => String(n.id) === String(id));
            if (idx > -1) cached[idx].lida = true;
            // decrementa contador com seguran√ßa
            lastCount = Math.max(0, lastCount - 1);
            renderBadge(lastCount);
            // re-renderiza lista atualizada (mant√©m filtro)
            renderList(cached);
            // se tiver link, navega
            if (link) {
              window.location.href = link;
            }
          } else {
            console.error("Erro marcando notifica√ß√£o como lida", res.status);
          }
        } catch (err) {
          console.error("Erro de rede ao marcar lida", err);
        }
      });
    });
  }

  /* -------------------------
     FETCH CONTADORES / LISTAS
  --------------------------*/
  async function fetchCount() {
    try {
      const r = await fetch(COUNT_URL, { credentials: "same-origin" });
      if (!r.ok) return 0;
      const j = await r.json();
      return j.count || 0;
    } catch (e) {
      return 0;
    }
  }

  async function fetchList(limit=10) {
    try {
      const r = await fetch(LIST_URL + "?limit=" + limit, { credentials: "same-origin" });
      if (!r.ok) return [];
      const j = await r.json();
      return j.notificacoes || [];
    } catch (e) {
      return [];
    }
  }

  async function fetchNovas() {
    try {
      const r = await fetch(NOVAS_URL, { credentials: "same-origin" });
      if (!r.ok) return [];
      const j = await r.json();
      return j.novas || [];
    } catch (e) {
      return [];
    }
  }

  /* -------------------------
     ATUALIZA√á√ÉO INTELIGENTE
  --------------------------*/
  async function fetchCountAndMaybeList() {
    const cnt = await fetchCount();
    if (cnt !== lastCount) {
      lastCount = cnt;
      renderBadge(cnt);
      const list = await fetchList();
      renderList(list);
    }
  }

  /* -------------------------
     INICIALIZA√á√ÉO
  --------------------------*/
  (async () => {
    lastCount = await fetchCount();
    renderBadge(lastCount);

    const list = await fetchList();
    renderList(list);

    // mostra toasts das novas (quando houver) uma √∫nica vez na carga inicial
    const novas = await fetchNovas();
    if (novas.length) {
      novas.forEach(n => {
        const box = document.createElement("div");
        box.className = "alert alert-info position-fixed top-0 end-0 m-3 shadow-sm";
        box.style.zIndex = "9999";
        box.innerHTML = `<strong>${n.titulo}</strong><div class="small">${n.mensagem}</div>`;
        document.body.appendChild(box);
        setTimeout(() => box.remove(), 6000);
      });
      // atualiza lista/badge j√° que pode ter mudado
      await fetchCountAndMaybeList();
    }

    // polling leve a cada 4s
    setInterval(async () => {
      const cnt = await fetchCount();
      if (cnt !== lastCount) {
        const novas = await fetchNovas();
        novas.forEach(n => {
          const box = document.createElement("div");
          box.className = "alert alert-info position-fixed top-0 end-0 m-3 shadow-sm";
          box.style.zIndex = "9999";
          box.innerHTML = `<strong>${n.titulo}</strong><div class="small">${n.mensagem}</div>`;
          document.body.appendChild(box);
          setTimeout(() => box.remove(), 6000);
        });
        await fetchCountAndMaybeList();
      }
    }, 4000);
  })();

  /* -------------------------
     FILTROS (TABS)
  --------------------------*/
  function setFilter(f) {
    currentFilter = f;
    tabAll.classList.toggle("active", f === "all");
    tabUnread.classList.toggle("active", f === "unread");
    tabRead.classList.toggle("active", f === "read");
    renderList(cached);
  }

  tabAll && tabAll.addEventListener("click", () => setFilter("all"));
  tabUnread && tabUnread.addEventListener("click", () => setFilter("unread"));
  tabRead && tabRead.addEventListener("click", () => setFilter("read"));

  /* -------------------------
     AO ABRIR O DROPDOWN (ATUALIZA LISTA)
  --------------------------*/
  if (notifToggle) {
    notifToggle.addEventListener("click", () => {
      // pequeno delay para permitir anima√ß√£o do bootstrap abrir primeiro
      setTimeout(async () => {
        const list = await fetchList();
        renderList(list);
        lastCount = await fetchCount();
        renderBadge(lastCount);
      }, 160);
    });
  }

});
</script>
{% endif %}
{% endblock %}
</body>
</html>
